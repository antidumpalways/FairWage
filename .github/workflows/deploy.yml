name: ğŸš€ Deploy FairWage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  RUST_VERSION: '1.70'

jobs:
  # Test and Build
  test-and-build:
    runs-on: ubuntu-latest
    name: ğŸ§ª Test & Build
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ¦€ Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          target: wasm32-unknown-unknown
          override: true
          
      - name: ğŸ“¦ Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          
      - name: ğŸ”¨ Build Rust contracts
        run: |
          cd Backend
          cargo build --target wasm32-unknown-unknown --release
          
      - name: ğŸ“‹ List build artifacts
        run: |
          ls -la Backend/target/wasm32-unknown-unknown/release/
          
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: Frontend/package-lock.json
          
      - name: ğŸ“¦ Install Frontend dependencies
        run: |
          cd Frontend
          npm ci
          
      - name: ğŸ§ª Run Frontend tests
        run: |
          cd Frontend
          npm run lint
          npm run build
          
      - name: ğŸ“¦ Cache build artifacts
        uses: actions/cache@v3
        with:
          path: |
            Frontend/.next
            Frontend/out
          key: ${{ runner.os }}-nextjs-${{ hashFiles('Frontend/package-lock.json') }}
          
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            Backend/target/wasm32-unknown-unknown/release/*.wasm
            Frontend/.next
            Frontend/out

  # Deploy to Testnet (on main branch)
  deploy-testnet:
    needs: test-and-build
    runs-on: ubuntu-latest
    name: ğŸŒ Deploy to Testnet
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts
          
      - name: ğŸ¦€ Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          target: wasm32-unknown-unknown
          override: true
          
      - name: ğŸ”§ Setup Soroban CLI
        run: |
          curl -sSfL https://soroban.stellar.org/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
      - name: ğŸš€ Deploy to Testnet
        env:
          SOROBAN_NETWORK: testnet
          SOROBAN_RPC_URL: https://soroban-testnet.stellar.org
          SOROBAN_NETWORK_PASSPHRASE: "Test SDF Network ; September 2015"
        run: |
          echo "ğŸš€ Deploying FairWage contract to testnet..."
          
          # Install WASM to network
          WASM_HASH=$(soroban contract install \
            --wasm Backend/target/wasm32-unknown-unknown/release/fair_wage_contract.wasm \
            --network testnet)
          
          echo "âœ… WASM installed with hash: $WASM_HASH"
          echo "WASM_HASH=$WASM_HASH" >> $GITHUB_ENV
          
          # Deploy contract
          CONTRACT_ID=$(soroban contract deploy \
            --wasm-hash $WASM_HASH \
            --network testnet)
          
          echo "âœ… Contract deployed with ID: $CONTRACT_ID"
          echo "CONTRACT_ID=$CONTRACT_ID" >> $GITHUB_ENV
          
      - name: ğŸ“‹ Create deployment summary
        run: |
          echo "## ğŸš€ Testnet Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**WASM Hash:** \`${{ env.WASM_HASH }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Contract ID:** \`${{ env.CONTRACT_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Network:** Testnet" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Successfully deployed" >> $GITHUB_STEP_SUMMARY

  # Deploy Frontend to Vercel (on main branch)
  deploy-frontend:
    needs: test-and-build
    runs-on: ubuntu-latest
    name: ğŸŒ Deploy Frontend
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts
          
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: Frontend/package-lock.json
          
      - name: ğŸ“¦ Install Frontend dependencies
        run: |
          cd Frontend
          npm ci
          
      - name: ğŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./Frontend
          vercel-args: '--prod'

  # Security and Quality Checks
  security:
    runs-on: ubuntu-latest
    name: ğŸ”’ Security & Quality
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: Frontend/package-lock.json
          
      - name: ğŸ“¦ Install dependencies
        run: |
          cd Frontend
          npm ci
          
      - name: ğŸ” Run security audit
        run: |
          cd Frontend
          npm audit --audit-level moderate
          
      - name: ğŸ§¹ Run linting
        run: |
          cd Frontend
          npm run lint
          
      - name: ğŸ“Š Check bundle size
        run: |
          cd Frontend
          npm run build
          npx @next/bundle-analyzer

  # Notify on completion
  notify:
    needs: [deploy-testnet, deploy-frontend, security]
    runs-on: ubuntu-latest
    name: ğŸ“¢ Notify Team
    if: always()
    
    steps:
      - name: ğŸ“Š Deployment Status
        run: |
          if [ "${{ needs.deploy-testnet.result }}" == "success" ] && [ "${{ needs.deploy-frontend.result }}" == "success" ]; then
            echo "ğŸ‰ All deployments successful!"
            echo "âœ… Testnet: ${{ needs.deploy-testnet.result }}"
            echo "âœ… Frontend: ${{ needs.deploy-frontend.result }}"
            echo "âœ… Security: ${{ needs.security.result }}"
          else
            echo "âŒ Some deployments failed"
            echo "Testnet: ${{ needs.deploy-testnet.result }}"
            echo "Frontend: ${{ needs.deploy-frontend.result }}"
            echo "Security: ${{ needs.security.result }}"
            exit 1
          fi
